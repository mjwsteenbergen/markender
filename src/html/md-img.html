<style>
    md-img {
        page-break-inside: avoid;
    }

    img.center {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }

    md-img div {
	    margin-bottom: 10px;
    }

    
    md-img div span {
        display: block;
        text-align: center;
        margin-top: 5px;
    }

    md-img div img {
        max-width: 100%;
        max-height: 100%;
    }

    md-img[super-small] div img {
        max-height: 40mm; 
        max-width: 75%;
    }

    md-img[small] div img {
        max-height: 74mm; 
        max-width: 75%;
    }

    md-img[medium] div img {
        max-height: 120mm; 
        max-width: 75%;
    }

    ul[collage] md-img {
        align-self: flex-end;
        vertical-align: middle;
        padding-left: 5px;
        padding-right: 5px;
    }

    ul[collage] {
        padding: 0;
        display: flex;
        width: 100%;
        page-break-inside: avoid;
    }

    md-img .wrapper {
        page-break-inside: avoid;
    }

    md-img[full] {
        height: 290mm;        
    }

    md-img[full] div{
        page-break-before: always;
        page-break-after: always;
        display: table-cell;
        vertical-align: middle;
    }


</style>

<template id="md-img">
    <div class="wrapper">
        <img/>
        <span class="md-img-desc"></span>
    </div>
</template>

<script>
    // Refers to the "importer", which is index.html
    var thatDoc = document;
    // Refers to the "importee", which is src/hello-world.html
    var thisDoc =  (thatDoc._currentScript || thatDoc.currentScript).ownerDocument;
    // Gets content from <template>
    var mdimgtemplate = thisDoc.querySelector('#md-img').content;

    class MdImage extends HTMLElement {
        
        constructor() {
            super();
            // var shadow = this.attachShadow({mode: 'open'});
        }

        connectedCallback() {
            var clone = document.importNode(mdimgtemplate, true);
            var index = 1;
            var usedIndex = -1;
            document.querySelectorAll("md-img").forEach((item) => {
                if(item === this){
                    usedIndex = index;
                    return;
                }
                index++;
            });

            var alignment = this.getAttribute("align") || "center";

            var img = clone.querySelectorAll("img")[0]; 
            img.setAttribute("src", this.getAttribute("src"));
            img.className = "center"
            var alt = clone.querySelectorAll(".md-img-desc")[0];
            var alt_text = this.getAttribute("alt") || "";
            if(alt_text !== "")
            {
                alt_text = ": " + alt_text;
            }
            alt.innerHTML = "Figure " + usedIndex + alt_text;
            this.className = alignment;
            var div = clone.querySelectorAll("div")[0];
            this.appendChild(clone);

            var id = this.getAttribute("id") || "fig:"+usedIndex;
            this.setAttribute("id", id);
            var outside = this;
            document.addEventListener("readystatechange", function(event) {
                
                var storage = outside.getLinkStorageOrCreate();
                storage.setLink(id, "Figure " + usedIndex, "#" + id);
            });
        }

        getLinkStorageOrCreate() {
            var storage = document.getElementsByTagName("md-link-storage");
            if(storage.length > 0) {
                return storage[0];
            } else {
                var storage = document.createElement("md-link-storage");
                document.body.appendChild(storage);
                return storage;
            }

        }

    }
    window.customElements.define('md-img', MdImage);
</script>